FROM kalilinux/kali-rolling:latest

# Set non-interactive mode
ENV DEBIAN_FRONTEND=noninteractive

# Install sudo and create test user
RUN apt-get update && \
    apt-get install -y sudo && \
    useradd -m -s /bin/bash testuser && \
    echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Copy project files
COPY . /home/testuser/assassinate
RUN chown -R testuser:testuser /home/testuser/assassinate

# Switch to test user
USER testuser
WORKDIR /home/testuser/assassinate

# Run installation script
RUN bash scripts/install/kali.sh

# Test the build
RUN cd assassinate_bridge && \
    ~/.cargo/bin/cargo test --lib --release

CMD ["/bin/bash"]
