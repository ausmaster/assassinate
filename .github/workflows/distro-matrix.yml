name: Multi-Distro Validation

on:
  push:
    branches: [ main, test/* ]
  pull_request:
    branches: [ main ]

jobs:
  ubuntu-full-test:
    name: Ubuntu 24.04 Full Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            curl \
            libssl-dev \
            pkg-config \
            libclang-dev \
            libpcap-dev \
            postgresql \
            postgresql-contrib \
            libpq-dev \
            ruby-full \
            ruby-dev

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Clone Metasploit Framework
        run: |
          git clone --depth 1 https://github.com/rapid7/metasploit-framework.git ~/metasploit-framework

      - name: Install MSF Dependencies
        run: |
          cd ~/metasploit-framework
          sudo gem install bundler
          # Use single-threaded install to avoid race conditions
          sudo bundle install --jobs 1

      - name: Setup PostgreSQL
        run: |
          # Drop existing cluster and recreate properly
          sudo pg_dropcluster --stop 16 main || true
          sudo pg_createcluster 16 main --start

          # Update pg_hba.conf to allow trust authentication for localhost
          sudo sed -i 's/host.*all.*all.*127\.0\.0\.1\/32.*scram-sha-256/host    all             all             127.0.0.1\/32            trust/' /etc/postgresql/16/main/pg_hba.conf
          sudo sed -i 's/host.*all.*all.*::1\/128.*scram-sha-256/host    all             all             ::1\/128                 trust/' /etc/postgresql/16/main/pg_hba.conf

          # Reload PostgreSQL to apply config changes
          sudo -u postgres /usr/lib/postgresql/16/bin/pg_ctl -D /var/lib/postgresql/16/main reload

          # Create user and database
          sudo -u postgres psql -c "CREATE USER ${USER} SUPERUSER;" || echo "User may already exist"
          sudo -u postgres psql -c "CREATE DATABASE msf_test OWNER ${USER};" || echo "Database may already exist"

          # Create database.yml for MSF
          cat > $HOME/metasploit-framework/config/database.yml <<EOF
          development: &pgsql
            adapter: postgresql
            database: msf_test
            username: ${USER}
            password:
            host: localhost
            port: 5432
            pool: 200
            timeout: 5
          production: &production
            <<: *pgsql
          test:
            <<: *pgsql
          EOF

          # Run database migrations
          cd $HOME/metasploit-framework
          export RAILS_ENV=test
          bundle exec rake db:migrate

      - name: Build Rust Bridge
        working-directory: assassinate_bridge
        run: cargo build --release

      - name: Verify Rust Bridge Build
        run: |
          cd assassinate_bridge
          ls -lh target/release/libassassinate_bridge.*

      - name: Run Rust Bridge Tests
        working-directory: assassinate_bridge
        run: |
          export MSF_ROOT="$HOME/metasploit-framework"
          cargo test --release --lib

      - name: Run MSF Framework Test Suite
        run: |
          cd $HOME/metasploit-framework
          export MSF_ROOT="$HOME/metasploit-framework"
          bundle exec rspec spec/lib/msf/core/ \
            --exclude-pattern "**/opt_address_local_spec.rb" \
            --format progress \
            --format documentation \
            --out test_results.txt

  distro-install-validation:
    name: ${{ matrix.distro }} Validation Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: Debian
            image: debian:bookworm
            pkg_manager: apt-get
          - distro: Kali
            image: kalilinux/kali-rolling:latest
            pkg_manager: apt-get
          - distro: Parrot
            image: parrotsec/security:latest
            pkg_manager: apt-get
          - distro: Ubuntu
            image: ubuntu:24.04
            pkg_manager: apt-get
          - distro: Fedora
            image: fedora:latest
            pkg_manager: dnf
          - distro: Arch
            image: archlinux:latest
            pkg_manager: pacman
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Test ${{ matrix.distro }} Installation and Bridge Tests
        run: |
          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ matrix.image }} \
            bash -c "
              set -e
              echo '=== Testing ${{ matrix.distro }} - Installation and Bridge Tests ==='

              # Update package lists based on distro
              if command -v apt-get &> /dev/null; then
                apt-get update
                apt-get install -y \
                  build-essential \
                  curl \
                  git \
                  libssl-dev \
                  pkg-config \
                  libclang-dev \
                  libpcap-dev \
                  postgresql \
                  postgresql-contrib \
                  libpq-dev \
                  ruby-full \
                  ruby-dev \
                  libyaml-dev \
                  libffi-dev
              elif command -v dnf &> /dev/null; then
                dnf install -y \
                  gcc \
                  gcc-c++ \
                  make \
                  curl \
                  git \
                  openssl-devel \
                  pkg-config \
                  clang-devel \
                  libpcap-devel \
                  postgresql \
                  postgresql-server \
                  postgresql-devel \
                  ruby \
                  ruby-devel \
                  libyaml-devel \
                  libffi-devel
              elif command -v pacman &> /dev/null; then
                pacman -Sy --noconfirm \
                  base-devel \
                  curl \
                  git \
                  openssl \
                  pkg-config \
                  clang \
                  libpcap \
                  postgresql \
                  postgresql-libs \
                  ruby \
                  libyaml \
                  libffi
              fi

              # Install Rust
              echo 'Installing Rust toolchain...'
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              source \$HOME/.cargo/env

              # Verify Rust installation
              echo 'Rust toolchain installed:'
              rustc --version
              cargo --version

              # Clone Metasploit Framework
              echo 'Cloning Metasploit Framework...'
              git clone --depth 1 https://github.com/rapid7/metasploit-framework.git /tmp/metasploit-framework

              # Install MSF Ruby dependencies
              echo 'Installing MSF dependencies...'
              cd /tmp/metasploit-framework
              gem install bundler

              # Use single-threaded install to avoid race conditions
              # See: https://github.com/bundler/bundler/issues/6698
              bundle install --jobs 1

              # Setup PostgreSQL
              echo 'Setting up PostgreSQL...'
              if command -v apt-get &> /dev/null || command -v dnf &> /dev/null; then
                # Initialize PostgreSQL for Fedora
                if command -v dnf &> /dev/null; then
                  postgresql-setup --initdb || true
                fi

                # Start PostgreSQL
                if command -v pg_ctlcluster &> /dev/null; then
                  pg_ctlcluster \$(pg_lsclusters -h | head -1 | awk '{print \$1, \$2}') start || true
                else
                  su - postgres -c 'pg_ctl -D /var/lib/pgsql/data start' || true
                fi

                # Wait for PostgreSQL to start
                sleep 5
              fi

              # Build and test Rust bridge
              echo 'Building Rust bridge...'
              cd /workspace/assassinate_bridge
              cargo build --release

              # Verify bridge library exists
              echo 'Bridge library built:'
              ls -lh target/release/libassassinate_bridge.*

              # Run Rust bridge tests with MSF
              echo 'Running Rust bridge tests...'
              export MSF_ROOT=/tmp/metasploit-framework
              cargo test --release -- --test-threads=1

              echo '=== ${{ matrix.distro }} validation completed successfully ==='
            "
