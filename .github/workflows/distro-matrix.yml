name: Multi-Distro Validation

on:
  push:
    branches: [ main, test/* ]
  pull_request:
    branches: [ main ]

jobs:
  ubuntu-full-test:
    name: Ubuntu 24.04 Full Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            curl \
            libssl-dev \
            pkg-config \
            libclang-dev \
            libpcap-dev \
            postgresql \
            postgresql-contrib \
            libpq-dev \
            ruby-full \
            ruby-dev

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Clone Metasploit Framework
        run: |
          git clone --depth 1 https://github.com/rapid7/metasploit-framework.git metasploit-framework

      - name: Install MSF Dependencies
        run: |
          cd metasploit-framework
          sudo gem install bundler
          # Use single-threaded install to avoid race conditions
          sudo bundle install --jobs 1

      - name: Setup PostgreSQL
        run: |
          # Drop existing cluster and recreate properly
          sudo pg_dropcluster --stop 16 main || true
          sudo pg_createcluster 16 main --start

          # Update pg_hba.conf to allow trust authentication for localhost
          sudo sed -i 's/host.*all.*all.*127\.0\.0\.1\/32.*scram-sha-256/host    all             all             127.0.0.1\/32            trust/' /etc/postgresql/16/main/pg_hba.conf
          sudo sed -i 's/host.*all.*all.*::1\/128.*scram-sha-256/host    all             all             ::1\/128                 trust/' /etc/postgresql/16/main/pg_hba.conf

          # Reload PostgreSQL to apply config changes
          sudo -u postgres /usr/lib/postgresql/16/bin/pg_ctl -D /var/lib/postgresql/16/main reload

          # Create user and database
          sudo -u postgres psql -c "CREATE USER ${USER} SUPERUSER;" || echo "User may already exist"
          sudo -u postgres psql -c "CREATE DATABASE msf_test OWNER ${USER};" || echo "Database may already exist"

          # Create database.yml for MSF
          cat > ${{ github.workspace }}/metasploit-framework/config/database.yml <<EOF
          development: &pgsql
            adapter: postgresql
            database: msf_test
            username: ${USER}
            password:
            host: localhost
            port: 5432
            pool: 200
            timeout: 5
          production: &production
            <<: *pgsql
          test:
            <<: *pgsql
          EOF

          # Run database migrations
          cd ${{ github.workspace }}/metasploit-framework
          export RAILS_ENV=test
          bundle exec rake db:migrate

      - name: Build All Rust Components
        run: |
          cd rust/ipc && cargo build --release
          cd ../bridge && cargo build --release
          cd ../daemon && cargo build --release

      - name: Verify Rust Build
        run: |
          ls -lh rust/bridge/target/release/libbridge.*
          ls -lh rust/daemon/target/release/daemon

      - name: Run Rust Unit Tests
        working-directory: rust/bridge
        run: cargo test --release --lib
        env:
          MSF_ROOT: ${{ github.workspace }}/metasploit-framework

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.13

      - name: Install Python Dependencies
        run: uv sync --all-extras

      - name: Run Python Integration Tests
        run: uv run pytest tests/ -v --tb=short --maxfail=5
        env:
          MSF_ROOT: ${{ github.workspace }}/metasploit-framework
          ASSASSINATE_LOG_LEVEL: WARNING

  distro-install-validation:
    name: ${{ matrix.distro }} Validation Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: Debian
            image: debian:bookworm
            pkg_manager: apt-get
          - distro: Kali
            image: kalilinux/kali-rolling:latest
            pkg_manager: apt-get
          - distro: Parrot
            image: parrotsec/security:latest
            pkg_manager: apt-get
          - distro: Ubuntu
            image: ubuntu:24.04
            pkg_manager: apt-get
          - distro: Fedora
            image: fedora:latest
            pkg_manager: dnf
          - distro: Arch
            image: archlinux:latest
            pkg_manager: pacman
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Test ${{ matrix.distro }} Installation and Bridge Tests
        run: |
          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ matrix.image }} \
            bash -c "
              set -e
              echo '=== Testing ${{ matrix.distro }} - Installation and Bridge Tests ==='

              # Update package lists based on distro
              if command -v apt-get &> /dev/null; then
                apt-get update
                apt-get install -y \
                  build-essential \
                  curl \
                  git \
                  libssl-dev \
                  pkg-config \
                  libclang-dev \
                  libpcap-dev \
                  postgresql \
                  postgresql-contrib \
                  libpq-dev \
                  ruby-full \
                  ruby-dev \
                  libyaml-dev \
                  libffi-dev
              elif command -v dnf &> /dev/null; then
                dnf install -y \
                  gcc \
                  gcc-c++ \
                  make \
                  curl \
                  git \
                  openssl-devel \
                  pkg-config \
                  clang-devel \
                  libpcap-devel \
                  postgresql \
                  postgresql-server \
                  postgresql-devel \
                  ruby \
                  ruby-devel \
                  libyaml-devel \
                  libffi-devel
              elif command -v pacman &> /dev/null; then
                pacman -Sy --noconfirm \
                  base-devel \
                  curl \
                  git \
                  openssl \
                  pkg-config \
                  clang \
                  libpcap \
                  postgresql \
                  postgresql-libs \
                  ruby \
                  libyaml \
                  libffi
              fi

              # Install Rust
              echo 'Installing Rust toolchain...'
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              source \$HOME/.cargo/env

              # Verify Rust installation
              echo 'Rust toolchain installed:'
              rustc --version
              cargo --version

              # Setup Metasploit Framework based on distro
              # Kali and Parrot use package manager (real-world usage)
              # Others clone from GitHub
              if [[ '${{ matrix.distro }}' == 'Kali' ]] || [[ '${{ matrix.distro }}' == 'Parrot' ]]; then
                echo 'Installing Metasploit Framework from package manager...'
                apt-get install -y metasploit-framework
                export MSF_ROOT=/usr/share/metasploit-framework
                echo 'Using package MSF at /usr/share/metasploit-framework'
              else
                echo 'Cloning Metasploit Framework from GitHub...'
                git clone --depth 1 https://github.com/rapid7/metasploit-framework.git /tmp/metasploit-framework
                export MSF_ROOT=/tmp/metasploit-framework

                # Install MSF Ruby dependencies for cloned version
                echo 'Installing MSF dependencies...'
                cd /tmp/metasploit-framework
                gem install bundler

                # Fix PATH for Arch Linux gem executables
                # See: https://wiki.archlinux.org/title/Ruby
                if command -v pacman &> /dev/null; then
                  export PATH=\"\$(ruby -e 'puts Gem.user_dir')/bin:\$PATH\"
                fi

                # Workaround for Kali: xmlrpc gem fails during bundle install
                # Install it separately first to avoid Bundler::GemNotFound error
                # See: https://github.com/beefproject/beef/issues/2687
                gem install xmlrpc

                # Use single-threaded install to avoid race conditions
                # Retry network errors (e.g., xmlrpc gem not found)
                # No timeout - let GitHub Actions job timeout handle it (360min default)
                # Bundle install for MSF can take 10-15 minutes depending on network
                # See: https://github.com/bundler/bundler/issues/6698
                bundle install --jobs 1 --retry 3
              fi

              # Setup PostgreSQL
              echo 'Setting up PostgreSQL...'
              if command -v apt-get &> /dev/null || command -v dnf &> /dev/null; then
                # Initialize PostgreSQL for Fedora
                if command -v dnf &> /dev/null; then
                  postgresql-setup --initdb || true
                fi

                # Start PostgreSQL
                if command -v pg_ctlcluster &> /dev/null; then
                  pg_ctlcluster \$(pg_lsclusters -h | head -1 | awk '{print \$1, \$2}') start || true
                else
                  su - postgres -c 'pg_ctl -D /var/lib/pgsql/data start' || true
                fi

                # Wait for PostgreSQL to start
                sleep 5
              fi

              # Build all Rust components
              echo 'Building all Rust components...'
              cd /workspace/rust/ipc && cargo build --release
              cd /workspace/rust/bridge && cargo build --release
              cd /workspace/rust/daemon && cargo build --release

              # Verify all components built
              echo 'Components built:'
              ls -lh /workspace/rust/bridge/target/release/libbridge.*
              ls -lh /workspace/rust/daemon/target/release/daemon

              # Run Rust unit tests
              echo 'Running Rust unit tests...'
              cd /workspace/rust/bridge
              cargo test --release --lib

              # Install uv (Python package manager)
              echo 'Installing uv...'
              curl -LsSf https://astral.sh/uv/install.sh | sh
              source \$HOME/.local/bin/env

              # Install Python dependencies
              echo 'Installing Python dependencies...'
              cd /workspace
              uv sync --all-extras

              # Setup PostgreSQL database
              echo 'Setting up MSF database...'
              cd \$MSF_ROOT
              cat > config/database.yml <<EOF
              development: &pgsql
                adapter: postgresql
                database: msf_test
                username: postgres
                password:
                host: localhost
                port: 5432
                pool: 200
                timeout: 5
              production: &production
                <<: *pgsql
              test:
                <<: *pgsql
              EOF

              # Run Python integration test suite
              echo 'Running Python integration tests (118 tests)...'
              echo \"Using MSF_ROOT: \$MSF_ROOT\"
              cd /workspace
              export ASSASSINATE_LOG_LEVEL=WARNING
              uv run pytest tests/ -v --tb=short --maxfail=5

              echo '=== ${{ matrix.distro }} validation completed successfully ==='
            "
